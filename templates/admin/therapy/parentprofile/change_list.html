{% extends "admin/change_list.html" %}

{% block content_title %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>{{ title }}</h1>
        {% if show_assign_task_button %}
            <div>
                <button type="button" id="assign-task-btn" style="
                    background-color: #2c8aa6; 
                    color: white; 
                    border: none; 
                    padding: 10px 20px; 
                    border-radius: 6px; 
                    font-weight: 600; 
                    cursor: pointer; 
                    font-size: 14px;
                    display: none;
                ">
                    ðŸ“‹ Assign Tasks
                </button>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block extrahead %}
    {{ block.super }}
    {% if show_assign_task_button %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const assignBtn = document.getElementById('assign-task-btn');
            const table = document.querySelector('#result_list');
            
            if (assignBtn && table) {
                // Show button when there are clients
                const rows = table.querySelectorAll('tbody tr');
                if (rows.length > 0) {
                    assignBtn.style.display = 'inline-block';
                }
                
                // Handle button click - automatically use the first/only client
                assignBtn.addEventListener('click', function() {
                    const rows = table.querySelectorAll('tbody tr');
                    
                    if (rows.length === 0) {
                        alert('No clients available for task assignment.');
                        return;
                    }
                    
                    // If there's only one client, use it automatically
                    if (rows.length === 1) {
                        const editLink = rows[0].querySelector('a[href*="/change/"]');
                        if (editLink) {
                            const href = editLink.getAttribute('href');
                            const parentId = href.match(/\/(\d+)\/change\//)[1];
                            window.location.href = `/therapy/assign-task-wizard/?parent_id=${parentId}`;
                            return;
                        }
                    }
                    
                    // If multiple clients, show selection dialog
                    let clientOptions = '';
                    rows.forEach((row, index) => {
                        const nameCell = row.querySelector('td:nth-child(2)'); // Assuming name is in 2nd column
                        const editLink = row.querySelector('a[href*="/change/"]');
                        if (nameCell && editLink) {
                            const href = editLink.getAttribute('href');
                            const parentId = href.match(/\/(\d+)\/change\//)[1];
                            const clientName = nameCell.textContent.trim();
                            clientOptions += `<option value="${parentId}">${clientName}</option>`;
                        }
                    });
                    
                    if (clientOptions) {
                        const selectedClient = prompt(`Multiple clients found. Please enter the number (1-${rows.length}) for the client you want to assign tasks to:\n\n${Array.from(rows).map((row, i) => `${i+1}. ${row.querySelector('td:nth-child(2)').textContent.trim()}`).join('\n')}`);
                        
                        if (selectedClient && !isNaN(selectedClient)) {
                            const clientIndex = parseInt(selectedClient) - 1;
                            if (clientIndex >= 0 && clientIndex < rows.length) {
                                const editLink = rows[clientIndex].querySelector('a[href*="/change/"]');
                                if (editLink) {
                                    const href = editLink.getAttribute('href');
                                    const parentId = href.match(/\/(\d+)\/change\//)[1];
                                    window.location.href = `/therapy/assign-task-wizard/?parent_id=${parentId}`;
                                }
                            } else {
                                alert('Invalid selection. Please try again.');
                            }
                        }
                    }
                });
            }
        });
    </script>
    {% endif %}
{% endblock %}